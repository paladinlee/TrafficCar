<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>乘客端 - 查看交通車</title>

    <!-- ✅ Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        /* ✅ 控制列：頂端中央浮動 + 自動收縮 */
        #controlBar {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            width: auto;
        }

        .control-container {
            background: rgba(255, 255, 255, 0.92);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            padding: 10px 15px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 10px;
            max-width: 95vw;
            backdrop-filter: blur(4px); /* ✅ 更高級的半透明效果 */
        }

        /* ✅ 響應式 - 窄螢幕時改為上下排列 */
        @media (max-width: 600px) {
            .control-container {
                flex-direction: column;
                align-items: stretch;
            }

            .control-container select,
            .control-container button {
                width: 100%;
            }
        }

        select, button {
        font-size: 16px !important;
        -webkit-text-size-adjust: 100%;
        }        
    </style>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDAAf1R7CgbsN2_RNj9DTnxt0GiFp66cBM"></script>
</head>

<body>
    <!-- ✅ 浮動控制列 -->
    <div id="controlBar">
        <div class="control-container">
            <select id="routeSelector" class="form-select w-auto">
                <option value="">-- 請選擇路線 --</option>
                <option value="bus001">民生線</option>
                <option value="bus002">重慶線</option>
                <option value="bus003">桃園線</option>
            </select>
            <button id="centerBusBtn" class="btn btn-primary d-none">回到交通車</button>
        </div>
    </div>

    <div id="map"></div> 

    <script>
        // === Firebase 初始化 ===
        const firebaseConfig = {
            apiKey: "AIzaSyCC5-P43u1VpAWx9NyX5jDE6U1kw_PeZPo",
            authDomain: "realtime-8bb89.firebaseapp.com",
            databaseURL: "https://realtime-8bb89-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "realtime-8bb89",
            storageBucket: "realtime-8bb89.firebasestorage.app",
            messagingSenderId: "266775316025",
            appId: "1:266775316025:web:65b4875009bd18fb39efe8"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const mapElement = document.getElementById("map");
        const centerBusBtn = document.getElementById("centerBusBtn");
        const routeSelector = document.getElementById("routeSelector");

        const map = new google.maps.Map(mapElement, { zoom: 16 });

        // === 狀態旗標 ===
        let isFirstUpdate = true;
        let userMovedMap = false;
        let currentRef = null;

        // === Bus Marker ===
        const busIcon = {
            url: "https://paladinlee.github.io/TrafficCar/images/bus.png",
            scaledSize: new google.maps.Size(48, 48),
            anchor: new google.maps.Point(24, 24)
        };

        let busMarker = new google.maps.Marker({
            map: map,
            icon: busIcon,
            title: "交通車"
        });

        // === 地圖互動 ===
        map.addListener('dragstart', () => userMovedMap = true);

        centerBusBtn.addEventListener('click', () => {
            if (busMarker.getPosition()) {
                map.panTo(busMarker.getPosition());
                userMovedMap = false;
            }
        });

        // ✅ 手機旋轉時自動重新置中與縮放控制列
        function repositionControlBar() {
        if (!controlBar) return;

        controlBar.style.transition = "none";
        controlBar.style.left = "50%";
        controlBar.style.transform = "translateX(-50%) scale(1)";

        // ✅ 橫向模式時縮小一點
        if (window.matchMedia("(orientation: landscape)").matches) {
            controlBar.style.transform = "translateX(-50%) scale(0.85)";
        }

        // ✅ 觸發 Google Map 重繪
        google.maps.event.trigger(map, 'resize');

        setTimeout(() => {
            controlBar.style.transition = "transform 0.3s ease";
        }, 200);
        }

        window.addEventListener('orientationchange', repositionControlBar);
        window.addEventListener('resize', repositionControlBar);
        window.addEventListener('load', repositionControlBar);        

        // === 畫出停靠站 ===
        const routesData = {
            "minA": {
                "name": "民生線(早)",
                "stops": [
                    { "time": "06:20", "place": "民生活動中心", "NE": "25.059271437032145,121.56358211908851" },
                    { "time": "06:25", "place": "南京松江捷運2號出口", "NE": "25.051306,121.532833" },
                    { "time": "06:33", "place": "富邦銀行", "NE": "25.032814437017937,121.53272406660767" },
                    { "time": "06:35", "place": "懷恩堂", "NE": "25.01778187784632,121.53337590495687" },
                    { "time": "06:38", "place": "台大活動中心對面", "NE": "25.012779593343435,121.53607488211394" },
                    { "time": "06:45", "place": "秀朗國小對面", "NE": "24.99991455208375,121.52115350315138" },
                    { "time": "06:50", "place": "景平路", "NE": "24.992867569562854,121.5111794012165" },
                    { "time": "06:55", "place": "景安捷運站", "NE": "24.993658370523,121.50484014313092" },
                    { "time": "06:58", "place": "圓通路口", "NE": "24.994003147253167,121.4959269239468" },
                    { "time": "07:00", "place": "中正路488號", "NE": "24.994396136160542,121.48924560522225" },
                    { "time": "07:55", "place": "74館前面", "NE": "24.773298360553607,121.0470121072169" },
                    { "time": "07:57", "place": "51館", "NE": "24.773885053363276,121.04450851525927" },
                    { "time": "07:59", "place": "22館", "NE": "24.776282129956005,121.04331336066015" },
                    { "time": "08:00", "place": "10P停車場", "NE": "24.772960106349874,121.04733012843961" }
                ]
            },
            "minB": {
                "name": "民生線(晚)",
                "stops": [
                    { "time": "17:05", "place": "64館","NE":"24.77432254848808,121.04683928028544" },
                    { "time": "17:07", "place": "24館","NE":"24.776447452891045,121.04390463440663" },
                    { "time": "17:09", "place": "51館","NE":"24.774032344077646,121.04431724442647" },
                    { "time": "18:00", "place": "中和交流道口","NE":"24.99416555873825,121.48819918705665" },
                    { "time": "18:02", "place": "圓通路口","NE":"24.99369119257283,121.49618487165249" },
                    { "time": "18:05", "place": "景安捷運站","NE":"24.993415515201274,121.50385648276482" },
                    { "time": "18:08", "place": "景平路薑母鴨","NE":"24.992523680209786,121.512094656228" },
                    { "time": "18:13", "place": "成功路得和路","NE":"24.99889916405774,121.52670233385945" },
                    { "time": "18:16", "place": "福和橋","NE":"25.010620360698923,121.53558533729586" },
                    { "time": "18:17", "place": "台大公館捷運站","NE":"25.013382532089253,121.53592728644752" },
                    { "time": "18:19", "place": "台大門口","NE":"25.01648795862203,121.53290311237788" },
                    { "time": "18:24", "place": "新生南路信義路","NE":"25.03298755727295,121.53306143661185" },
                    { "time": "18:27", "place": "新生南路濟南路","NE":"25.039930533254978,121.53293061382041" },
                    { "time": "18:32", "place": "松江南京","NE":"25.051256565773375,121.53311739512903" },
                    { "time": "18:40", "place": "民生東三民路","NE":"25.058645253348516,121.56234366416267" },
                ]
            },
            "toyanA": {
                "name": "桃園線(早)",
                "stops": [
                    { "time": "06:30", "place": "武陵站","NE":"24.989188797363397,121.28684204310855" },
                    { "time": "06:40", "place": "內壢站","NE":"24.973198542377137,121.25858031999513" },
                    { "time": "06:50", "place": "中壢站","NE":"24.955180450890825,121.22262220276085" },
                    { "time": "06:55", "place": "陽明站","NE":"24.949961986292806,121.21260175256837" },
                    { "time": "07:00", "place": "中豐站","NE":"24.94022438770063,121.2146051750025" },
                    { "time": "07:10", "place": "大溪站","NE":"24.896584249835477,121.2619444755453" },
                    { "time": "08:00", "place": "工研院","NE":"24.77444431182634,121.04781596412035" }
                ]
            },
            "toyanB": {
                "name": "桃園線(晚)",
                "stops": [
                    { "time": "17:03", "place": "71館","NE":"24.772920891313202,121.04672353230211" },
                    { "time": "17:05", "place": "51館","NE":"24.773892590241648,121.04451168275536" },
                    { "time": "17:07", "place": "11館","NE":"24.77654010238808,121.04208348243698" },
                    { "time": "", "place": "大溪站","NE":"24.895638627058577,121.26204997457822" },
                    { "time": "", "place": "中豐站","NE":"24.94034332999149,121.21463607078891" },
                    { "time": "", "place": "陽明站","NE":"24.949344796333136,121.21230727520945" },
                    { "time": "", "place": "中壢站","NE":"24.95525993927724,121.22272559301378" },
                    { "time": "", "place": "內壢站","NE":"24.972924905070226,121.25818394611817" },
                    { "time": "", "place": "武陵站","NE":"24.98925308953332,121.28731272341066" },
                ]
            }
		};
		
        let stopMarkers = [];

        function clearStopMarkers() {
            stopMarkers.forEach(m => m.setMap(null));
            stopMarkers = [];
        }

        function drawRouteStops(routeKey, color) {
            const route = routesData[routeKey];
            if (!route) return;
            const bounds = new google.maps.LatLngBounds();
            route.stops.forEach(stop => {
                const [lat, lng] = stop.NE.split(',').map(Number);
                const marker = new google.maps.Marker({
                    map: map,
                    position: { lat, lng },
                    icon: {
                        url: `http://maps.google.com/mapfiles/ms/icons/${color}-dot.png`
                    },
                    title: stop.place
                });
                stopMarkers.push(marker);
                bounds.extend(marker.getPosition());
            });
            map.fitBounds(bounds);
        }

        // === 路線切換事件 ===
        routeSelector.addEventListener("change", e => {
            const selectedRoute = e.target.value;
            isFirstUpdate = true;
            userMovedMap = false;

            clearStopMarkers();

            if (currentRef) {
                currentRef.off();
                currentRef = null;
            }

            if (selectedRoute === "") {
                centerBusBtn.classList.add("d-none");
                busMarker.setMap(null);
                return;
            }

            busMarker.setMap(map);
            centerBusBtn.classList.remove("d-none");

            // Firebase 資料監聽
            currentRef = db.ref("locations/" + selectedRoute);
            currentRef.on("value", snapshot => {
                const data = snapshot.val();
                if (data) {
                    const pos = { lat: data.lat, lng: data.lng };
                    busMarker.setPosition(pos);
                    if (isFirstUpdate && !userMovedMap) {
                        map.setCenter(pos);
                        isFirstUpdate = false;
                    }
                }
            });
        });
    </script>
</body>

</html>
