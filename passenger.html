<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>ä¹˜å®¢ç«¯ - æŸ¥çœ‹äº¤é€šè»Š</title>

  <!-- âœ… Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    html, body {
      height: 100%; margin: 0; padding: 0;
      background: #f5f5f5;
      touch-action: manipulation;
      -webkit-text-size-adjust: 100%;
    }

    #map { height: 100%; width: 100%; background: #ccc; }

    /* âœ… é ‚ç«¯ä¸­å¤®æµ®å‹•æ§åˆ¶åˆ— */
    #controlBar {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%) scale(1);
      z-index: 9999;
      width: auto;
      max-width: 95vw;
      transition: transform 0.3s ease;
      pointer-events: none;
    }

    .control-container {
      pointer-events: auto;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      gap: 10px;
      padding: 10px 15px;
      background: rgba(255, 255, 255, 0.92);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(6px);
    }
    
    html { font-size: 16px; }


    select, button {
      font-size: 16px !important;
      -webkit-text-size-adjust: 100%;
    }

    @media (max-width: 600px) {
      .control-container {
        flex-direction: column;
        align-items: stretch;
      }
      .control-container select,
      .control-container button {
        width: 100%;
      }
    }
  </style>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDAAf1R7CgbsN2_RNj9DTnxt0GiFp66cBM"></script>
</head>

<body>
  <div id="controlBar">
    <div class="control-container">
      <select id="routeSelector" class="form-select w-auto">
        <option value="">-- è«‹é¸æ“‡è·¯ç·š --</option>
        <option value="bus001">æ°‘ç”Ÿç·š</option>
        <option value="bus002">é‡æ…¶ç·š</option>
        <option value="bus003">æ¡ƒåœ’ç·š</option>
      </select>
      <button id="centerBusBtn" class="btn btn-primary d-none">å›åˆ°äº¤é€šè»Š</button>
    </div>
  </div>

  <div id="map"></div>

  <script>
    // === Firebase åˆå§‹åŒ– ===
    const firebaseConfig = {
      apiKey: "AIzaSyCC5-P43u1VpAWx9NyX5jDE6U1kw_PeZPo",
      authDomain: "realtime-8bb89.firebaseapp.com",
      databaseURL: "https://realtime-8bb89-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "realtime-8bb89",
      storageBucket: "realtime-8bb89.firebasestorage.app",
      messagingSenderId: "266775316025",
      appId: "1:266775316025:web:65b4875009bd18fb39efe8"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const mapEl = document.getElementById("map");
    const centerBusBtn = document.getElementById("centerBusBtn");
    const routeSelector = document.getElementById("routeSelector");
    const controlBar = document.getElementById("controlBar");

    const map = new google.maps.Map(mapEl, { zoom: 16,
        mapTypeControl: false,     // ğŸš« éš±è—ã€Œåœ°åœ– / è¡›æ˜Ÿã€åˆ‡æ›
        streetViewControl: false  // ï¼ˆå¯é¸ï¼‰éš±è—è¡—æ™¯å°äºº
     });

    let isFirstUpdate = true;
    let userMovedMap = false;
    let currentRef = null;

    const busIcon = {
      url: "https://paladinlee.github.io/TrafficCar/images/bus.png",
      scaledSize: new google.maps.Size(48, 48),
      anchor: new google.maps.Point(24, 24)
    };

    let busMarker = new google.maps.Marker({ map, icon: busIcon, title: "äº¤é€šè»Š" });
    map.addListener('dragstart', () => userMovedMap = true);

    centerBusBtn.addEventListener('click', () => {
      if (busMarker.getPosition()) {
        map.panTo(busMarker.getPosition());
        userMovedMap = false;
      }
    });

	// === ç•«å‡ºåœé ç«™ ===
	const routesData = {
		"minA": {
			"name": "æ°‘ç”Ÿç·š(æ—©)",
			"stops": [
				{ "time": "06:20", "place": "æ°‘ç”Ÿæ´»å‹•ä¸­å¿ƒ", "NE": "25.059271437032145,121.56358211908851" },
				{ "time": "06:25", "place": "å—äº¬æ¾æ±Ÿæ·é‹2è™Ÿå‡ºå£", "NE": "25.051306,121.532833" },
				{ "time": "06:33", "place": "å¯Œé‚¦éŠ€è¡Œ", "NE": "25.032814437017937,121.53272406660767" },
				{ "time": "06:35", "place": "æ‡·æ©å ‚", "NE": "25.01778187784632,121.53337590495687" },
				{ "time": "06:38", "place": "å°å¤§æ´»å‹•ä¸­å¿ƒå°é¢", "NE": "25.012779593343435,121.53607488211394" },
				{ "time": "06:45", "place": "ç§€æœ—åœ‹å°å°é¢", "NE": "24.99991455208375,121.52115350315138" },
				{ "time": "06:50", "place": "æ™¯å¹³è·¯", "NE": "24.992867569562854,121.5111794012165" },
				{ "time": "06:55", "place": "æ™¯å®‰æ·é‹ç«™", "NE": "24.993658370523,121.50484014313092" },
				{ "time": "06:58", "place": "åœ“é€šè·¯å£", "NE": "24.994003147253167,121.4959269239468" },
				{ "time": "07:00", "place": "ä¸­æ­£è·¯488è™Ÿ", "NE": "24.994396136160542,121.48924560522225" },
				{ "time": "07:55", "place": "74é¤¨å‰é¢", "NE": "24.773298360553607,121.0470121072169" },
				{ "time": "07:57", "place": "51é¤¨", "NE": "24.773885053363276,121.04450851525927" },
				{ "time": "07:59", "place": "22é¤¨", "NE": "24.776282129956005,121.04331336066015" },
				{ "time": "08:00", "place": "10Påœè»Šå ´", "NE": "24.772960106349874,121.04733012843961" }
			]
		},
		"minB": {
			"name": "æ°‘ç”Ÿç·š(æ™š)",
			"stops": [
				{ "time": "17:05", "place": "64é¤¨","NE":"24.77432254848808,121.04683928028544" },
				{ "time": "17:07", "place": "24é¤¨","NE":"24.776447452891045,121.04390463440663" },
				{ "time": "17:09", "place": "51é¤¨","NE":"24.774032344077646,121.04431724442647" },
				{ "time": "18:00", "place": "ä¸­å’Œäº¤æµé“å£","NE":"24.99416555873825,121.48819918705665" },
				{ "time": "18:02", "place": "åœ“é€šè·¯å£","NE":"24.99369119257283,121.49618487165249" },
				{ "time": "18:05", "place": "æ™¯å®‰æ·é‹ç«™","NE":"24.993415515201274,121.50385648276482" },
				{ "time": "18:08", "place": "æ™¯å¹³è·¯è–‘æ¯é´¨","NE":"24.992523680209786,121.512094656228" },
				{ "time": "18:13", "place": "æˆåŠŸè·¯å¾—å’Œè·¯","NE":"24.99889916405774,121.52670233385945" },
				{ "time": "18:16", "place": "ç¦å’Œæ©‹","NE":"25.010620360698923,121.53558533729586" },
				{ "time": "18:17", "place": "å°å¤§å…¬é¤¨æ·é‹ç«™","NE":"25.013382532089253,121.53592728644752" },
				{ "time": "18:19", "place": "å°å¤§é–€å£","NE":"25.01648795862203,121.53290311237788" },
				{ "time": "18:24", "place": "æ–°ç”Ÿå—è·¯ä¿¡ç¾©è·¯","NE":"25.03298755727295,121.53306143661185" },
				{ "time": "18:27", "place": "æ–°ç”Ÿå—è·¯æ¿Ÿå—è·¯","NE":"25.039930533254978,121.53293061382041" },
				{ "time": "18:32", "place": "æ¾æ±Ÿå—äº¬","NE":"25.051256565773375,121.53311739512903" },
				{ "time": "18:40", "place": "æ°‘ç”Ÿæ±ä¸‰æ°‘è·¯","NE":"25.058645253348516,121.56234366416267" },
			]
		},
		"toyanA": {
			"name": "æ¡ƒåœ’ç·š(æ—©)",
			"stops": [
				{ "time": "06:30", "place": "æ­¦é™µç«™","NE":"24.989188797363397,121.28684204310855" },
				{ "time": "06:40", "place": "å…§å£¢ç«™","NE":"24.973198542377137,121.25858031999513" },
				{ "time": "06:50", "place": "ä¸­å£¢ç«™","NE":"24.955180450890825,121.22262220276085" },
				{ "time": "06:55", "place": "é™½æ˜ç«™","NE":"24.949961986292806,121.21260175256837" },
				{ "time": "07:00", "place": "ä¸­è±ç«™","NE":"24.94022438770063,121.2146051750025" },
				{ "time": "07:10", "place": "å¤§æºªç«™","NE":"24.896584249835477,121.2619444755453" },
				{ "time": "08:00", "place": "å·¥ç ”é™¢","NE":"24.77444431182634,121.04781596412035" }
			]
		},
		"toyanB": {
			"name": "æ¡ƒåœ’ç·š(æ™š)",
			"stops": [
				{ "time": "17:03", "place": "71é¤¨","NE":"24.772920891313202,121.04672353230211" },
				{ "time": "17:05", "place": "51é¤¨","NE":"24.773892590241648,121.04451168275536" },
				{ "time": "17:07", "place": "11é¤¨","NE":"24.77654010238808,121.04208348243698" },
				{ "time": "", "place": "å¤§æºªç«™","NE":"24.895638627058577,121.26204997457822" },
				{ "time": "", "place": "ä¸­è±ç«™","NE":"24.94034332999149,121.21463607078891" },
				{ "time": "", "place": "é™½æ˜ç«™","NE":"24.949344796333136,121.21230727520945" },
				{ "time": "", "place": "ä¸­å£¢ç«™","NE":"24.95525993927724,121.22272559301378" },
				{ "time": "", "place": "å…§å£¢ç«™","NE":"24.972924905070226,121.25818394611817" },
				{ "time": "", "place": "æ­¦é™µç«™","NE":"24.98925308953332,121.28731272341066" },
			]
		}
	};
    let stopMarkers = [];
    function clearStopMarkers(){ stopMarkers.forEach(m=>m.setMap(null)); stopMarkers = []; }
    function drawRouteStops(routeKey, color){
      const route = routesData[routeKey]; if(!route) return;
      const bounds = new google.maps.LatLngBounds();
      route.stops.forEach(stop=>{
        const [lat,lng] = stop.NE.split(',').map(Number);
        const marker = new google.maps.Marker({
          map, position:{lat,lng},
          icon:{ url:`http://maps.google.com/mapfiles/ms/icons/${color}-dot.png` },
          title: stop.place
        });
        stopMarkers.push(marker);
        bounds.extend(marker.getPosition());
      });
      if(!bounds.isEmpty()){ map.fitBounds(bounds); setTimeout(()=> map.setZoom(16), 500); }
    }

    // === è·¯ç·šé¸æ“‡ ===
    routeSelector.addEventListener("change", e=>{
      const selectedRoute = e.target.value;
      isFirstUpdate = true; userMovedMap = false;
      clearStopMarkers();
      if(currentRef){ currentRef.off(); currentRef = null; }

      if(selectedRoute === ""){
        centerBusBtn.classList.add("d-none");
        busMarker.setMap(null);
        return;
      }

      const hour = new Date().getHours();
      const isMorning = hour < 12;
      if(selectedRoute === "bus001"){ drawRouteStops(isMorning?"minA":"minA","green"); }
      if(selectedRoute === "bus003"){ drawRouteStops(isMorning?"toyanA":"toyanA","green"); }

      busMarker.setMap(map);
      centerBusBtn.classList.remove("d-none");

      currentRef = db.ref("locations/" + selectedRoute);
      currentRef.on("value", snap=>{
        const data = snap.val();
        if(data){
          const pos = {lat:data.lat, lng:data.lng};
          busMarker.setPosition(pos);
          if(isFirstUpdate && !userMovedMap){ map.setCenter(pos); isFirstUpdate=false; }
        }
      });
    });

    // === URL åƒæ•¸è‡ªå‹•é¸è·¯ç·š ===
    function setDefaultRoute() {
      const params = new URLSearchParams(window.location.search);
      const type = params.get("type");
      if (type === "1") routeSelector.value = "bus001";
      else if (type === "2") routeSelector.value = "bus002";
      else if (type === "3") routeSelector.value = "bus003";
      if (routeSelector.value !== "") routeSelector.dispatchEvent(new Event("change"));
    }

    // === æ—‹è½‰ / é‡æ–°è¼‰å…¥è‡ªå‹•ä¿®æ­£ ===
    function repositionControlBar(){
      controlBar.style.transition="none";
      controlBar.style.left="50%";
      controlBar.style.transform="translateX(-50%) scale(1)";
      if(window.matchMedia("(orientation: landscape)").matches){
        controlBar.style.transform="translateX(-50%) scale(0.85)";
      }
      google.maps.event.trigger(map,'resize');
      setTimeout(()=> controlBar.style.transition="transform 0.3s ease",200);
    }

    window.addEventListener("pageshow", e=>{
        if(e.persisted){
            document.body.style.zoom = "100%";
            repositionControlBar();
            google.maps.event.trigger(map,'resize');
            // å¼·åˆ¶å†å°å»¶é²ä¸€æ¬¡
            setTimeout(()=> document.body.style.zoom="100%", 300);
        }      
    });
    window.addEventListener('orientationchange', repositionControlBar);
    window.addEventListener('resize', repositionControlBar);
    window.addEventListener('load', ()=>{ repositionControlBar(); setDefaultRoute(); });
  </script>
</body>
</html>
